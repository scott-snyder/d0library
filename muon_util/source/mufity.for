C DEC/CMS REPLACEMENT HISTORY, Element MUFITY.FOR
C *1     7-FEB-1990 14:51:37 HEDIN "INITIAL INSERT"
C DEC/CMS REPLACEMENT HISTORY, Element MUFITY.FOR
      SUBROUTINE MUFITY(NP,MODI,MODU,PLN,WIR,IP,XH,YH,ZH,DT012,
     A DT013,CHI4,LWIR)
CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC
CCCC CHANGEABLE ROUTINE TO PLAY WITH HITS ON TRACKS--NONBEND VIEW
CCCC                   delta T resolutions
CCCC INPUT : NP=NUMBER OF POINTS
CCCC         MODI = MODULE OF INTEREST; IF=0 THEN IGNORE
CCCC         MODU,PLN,WIR  MODULE,PLANE AND WIRE OF HIT
CCCC         IP  =  delta time flag if = 0 then not used
CCCC         XH,YH,ZH  INCLUDES TIMEDIVISION
CC  OUTPUT: DT012 3-MISS FOR DELTA T PLANES 0,1,2
CC          DT013 3-MISS FOR PLANES 0,1,3 (4-PLANE ONLY)
CC          CHI4  QUALITY OF FIT (4-PLANE ONLY)
CCCC        LWIR  MOST PROBABLE COMBO 
CCCC  DH 12/89: setup for single module
CCCC  DH 1/90 SET UP FOR 4 PLANE
CCCC  TD 4/26/91 FIXED MINOR BUG
CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC
      IMPLICIT NONE
      INTEGER NP,I,I110,I111,I112,I113,LWIR,NH(24),NN,MODI
      INTEGER SI,MOD
      PARAMETER (SI=40)
      REAL XH(SI),YH(SI),ZH(SI)
      INTEGER MODU(SI),PLN(SI),WIR(SI),IP(SI)
      REAL DEL,SLOPE,X,DT012,DT013,CHI4,SX,SZ,SXZ,SZ2,SX2,A,B,C,D,E
C
CCCCC   KLUGE MODULE NUMBERING
      MOD=MODI
      IF(MODU(1).EQ.1) MOD=0
      DT012=-9999999.
      DT013=-9999999.
      CHI4=-9999999.
      DO I=1,24
        NH(I)=0
      ENDDO
CCC   FIND MOST COMMON CELL NUMBER
      DO I=1,NP
      IF(MOD.NE.0) THEN
        IF(IP(I).NE.0.AND.MOD.EQ.MODU(I)) THEN
          NH(WIR(I)+1)=NH(WIR(I)+1)+1
        ENDIF
      ELSE
        IF(IP(I).NE.0) THEN
          NH(WIR(I)+1)=NH(WIR(I)+1)+1
        ENDIF
      ENDIF
      ENDDO
      LWIR=-1
      DO I=1,24
        IF(NH(I).EQ.3) LWIR=I-1
      ENDDO
      IF(LWIR.EQ.-1) THEN
        DO I=1,24
          IF(NH(I).EQ.2) LWIR=I-1
        ENDDO
      ENDIF
      IF(LWIR.EQ.-1) RETURN
      I110=0
      I111=0
      I112=0
      I113=0
      DO I=1,NP
      IF(MOD.NE.0) THEN
      IF(IP(I).NE.0.AND.MOD.EQ.MODU(I)) THEN
          NN=IABS(WIR(I)-LWIR)
          IF(PLN(I).EQ.0.AND.NN.LE.1) I110=I
          IF(PLN(I).EQ.1.AND.NN.LE.1) I111=I
          IF(PLN(I).EQ.2.AND.NN.LE.1) I112=I
          IF(PLN(I).EQ.3.AND.NN.LE.1) I113=I
        ENDIF
        ELSE
      IF(IP(I).NE.0) THEN
          NN=IABS(WIR(I)-LWIR)
          IF(PLN(I).EQ.0.AND.NN.LE.1) I110=I
          IF(PLN(I).EQ.1.AND.NN.LE.1) I111=I
          IF(PLN(I).EQ.2.AND.NN.LE.1) I112=I
          IF(PLN(I).EQ.3.AND.NN.LE.1) I113=I
        ENDIF
      ENDIF
      ENDDO
      IF(I110*I111*I112.EQ.0.AND.I110*I111*I113.EQ.0) LWIR=-1
      IF(I110*I111*I112.NE.0) THEN
        SLOPE=(XH(I110)-XH(I112))/(YH(I110)-YH(I112))
        X=XH(I110)+(YH(I111)-YH(I110))*SLOPE
        DT012=XH(I111)-X
      ENDIF
      IF(I110*I111*I113.NE.0) THEN
        SLOPE=(XH(I110)-XH(I113))/(YH(I110)-YH(I113))
        X=XH(I110)+(YH(I111)-YH(I110))*SLOPE
        DT013=XH(I111)-X
      ENDIF
C
C     FIT 4 POINTS
      IF(I110.NE.0.AND.I111.NE.0.AND.I112.NE.0.AND.I113.NE.0) THEN
        SX=XH(I110)+XH(I111)+XH(I112)+XH(I113)
        SZ=YH(I110)+YH(I111)+YH(I112)+YH(I113)
        SX2=XH(I110)**2+XH(I111)**2+XH(I112)**2+XH(I113)**2
        SZ2=YH(I110)**2+YH(I111)**2+YH(I112)**2+YH(I113)**2
        SXZ=XH(I110)*YH(I110)+XH(I111)*YH(I111)+
     A      XH(I112)*YH(I112)+XH(I113)*YH(I113)
        CALL MUSLIN(4.,SX,SZ,SX2,SZ2,SXZ,A,B,C,D,E,CHI4)
        IF(CHI4.GT.0.) CHI4=SQRT(CHI4/2.)
      ENDIF
      RETURN
      END
